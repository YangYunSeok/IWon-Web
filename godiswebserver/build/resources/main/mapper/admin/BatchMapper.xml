<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.godisweb.mapper.admin.BatchMapper">

    <select id="selectBatchGroups" parameterType="map" resultType="map">
    <![CDATA[
	SELECT TASK_GRP_ID
	     , TASK_GRP_NM
	     , TASK_GRP_DSC
	     , TASK_GRP_TP_CD
	     , UP_TASK_GRP_ID
	     , EXECUTE_PARM_VAL
	     , BAT_SCHDL_ID
	     , BAS_DD_CHK_YN
	     , TR_TASK_TP_CD
	     , USE_YN
	     , BAT_INIT_GRP_YN
	     , BAT_SMS_SND_TP_CD
	     , SORT_ORD
	  FROM GPCL_BAT_TASK_GRP
	 WHERE USE_YN = 'Y'
	 ORDER BY SORT_ORD
    ]]>
    </select>

    <select id="selectChildCnt" parameterType="string" resultType="int">
    <![CDATA[
    SELECT COUNT(*)
      FROM GPCL_BAT_TASK_GRP
     WHERE UP_TASK_GRP_ID = #{TASK_GRP_ID}
    ]]>
    </select>

    <select id="selectBatchFlow" parameterType="map" resultType="map">
    <![CDATA[
	SELECT TASK_GRP_ID
	     , TASK_GRP_NM
	     , GRP_XML_CONTN
	     , GRP_XML_ABBR_CONTN
	  FROM GPCL_BAT_TASK_GRP
	 WHERE TASK_GRP_ID = #{TASK_GRP_ID}
    ]]>
    </select>

    <select id="selectFileMaps" parameterType="map" resultType="map">
    <![CDATA[
	SELECT FILE_MAP_ID
         , MAP_INFO_ID
	     , MAP_INFO_NM
	     , UP_FILE_MAP_ID
	     , MAP_TP_CD
	     , SORT_ORD
	  FROM GPCL_FILE_MAP_INFO
	 ORDER BY SORT_ORD
    ]]>
    </select>

    <select id="selectStoredProc" parameterType="map" resultType="map">
    <![CDATA[
    WITH T_PROCS AS
    (
        SELECT DATABASE()            AS PROC_ID
             , DATABASE()            AS PROC_NM
             , NULL                  AS UP_PROC_ID
             , '02'                  AS PROC_TP_CD
         UNION ALL
        SELECT ROUTINE_NAME          AS PROC_ID
             , ROUTINE_COMMENT       AS PROC_NM
             , UPPER(ROUTINE_SCHEMA) AS UP_PROC_ID
             , '01'       AS PROC_TP_CD
          FROM INFORMATION_SCHEMA.ROUTINES
         WHERE ROUTINE_TYPE = 'PROCEDURE'
           AND UPPER(ROUTINE_SCHEMA) = DATABASE()
    )
    SELECT PROC_ID
         , PROC_NM
         , UP_PROC_ID
         , PROC_TP_CD
      FROM T_PROCS
     ORDER BY PROC_ID;
    ]]>
    </select>

    <insert id="insertBatchGroup" parameterType="map">
    <selectKey resultType="String" keyProperty="taskGrpId" order="BEFORE">
        SELECT CONCAT('GTASK', LPAD(CAST(IFNULL(MAX(CAST(REPLACE(TASK_GRP_ID, 'GTASK', '') AS DECIMAL)), 0) + 1 AS CHAR), 6, '0')) AS TASK_GRP_ID
          FROM GPCL_BAT_TASK_GRP
         WHERE TASK_GRP_ID NOT LIKE '%99999'
    </selectKey>
      INSERT INTO GPCL_BAT_TASK_GRP
      (
          TASK_GRP_ID
        , TASK_GRP_NM
        , TASK_GRP_DSC
        , TASK_GRP_TP_CD
        , UP_TASK_GRP_ID
        , EXECUTE_PARM_VAL
        , BAT_SCHDL_ID
        , GRP_XML_CONTN
        , GRP_XML_ABBR_CONTN
        , BAS_DD_CHK_YN
        , TR_TASK_TP_CD
        , USE_YN
        , BAT_INIT_GRP_YN
        , BAT_SMS_SND_TP_CD
        , SORT_ORD
        , REG_DDTM
        , REG_ID
        , LST_ADJ_DDTM
        , LST_ADJPRN_ID)
      VALUES
      (
          #{TASK_GRP_ID}
        , #{TASK_GRP_NM}
        , #{TASK_GRP_DSC}
        , #{TASK_GRP_TP_CD}
        , #{UP_TASK_GRP_ID}
        , #{EXECUTE_PARM_VAL}
        , #{BAT_SCHDL_ID}
        , #{GRP_XML_CONTN}
        , #{GRP_XML_ABBR_CONTN}
        , IFNULL(#{BAS_DD_CHK_YN},'Y')
        , #{TR_TASK_TP_CD}
        , IFNULL(#{USE_YN},'Y')
        , IFNULL(#{BAT_INIT_GRP_YN},'Y')
        , #{BAT_SMS_SND_TP_CD}
        , #{SORT_ORD}
        , DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
        , 'kicho'
        , DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
        , 'kicho'
      )
    </insert>

    <update id="updateBatchGroup" parameterType="map">
        UPDATE GPCL_BAT_TASK_GRP
           SET TASK_GRP_NM        = #{TASK_GRP_NM}
             , TASK_GRP_DSC       = #{TASK_GRP_DSC}
             , TASK_GRP_TP_CD     = #{TASK_GRP_TP_CD}
             , UP_TASK_GRP_ID     = #{UP_TASK_GRP_ID}
             , EXECUTE_PARM_VAL   = #{EXECUTE_PARM_VAL}
             , BAT_SCHDL_ID       = #{BAT_SCHDL_ID}
             , GRP_XML_CONTN      = #{GRP_XML_CONTN}
             , GRP_XML_ABBR_CONTN = #{GRP_XML_ABBR_CONTN}
             , BAS_DD_CHK_YN      = IFNULL(#{BAS_DD_CHK_YN},'Y')
             , TR_TASK_TP_CD      = #{TR_TASK_TP_CD}
             , USE_YN             = IFNULL(#{USE_YN},'Y')
             , BAT_INIT_GRP_YN    = IFNULL(#{BAT_INIT_GRP_YN},'N')
             , BAT_SMS_SND_TP_CD  = #{BAT_SMS_SND_TP_CD}
             , SORT_ORD           = #{SORT_ORD}
             , LST_ADJ_DDTM       = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
             , LST_ADJPRN_ID      = 'kicho'
        WHERE TASK_GRP_ID = #{taskGrpId}
    </update>

    <delete id="deleteBatchGroup" parameterType="map">
      DELETE FROM GPCL_BAT_TASK_GRP
       WHERE TASK_GRP_ID = #{taskGrpId}
    </delete>

    <update id="updateBatchFlow" parameterType="map">
      UPDATE GPCL_BAT_TASK_GRP
         SET GRP_XML_CONTN      = #{GRP_XML_CONTN}
           , GRP_XML_ABBR_CONTN = #{GRP_XML_ABBR_CONTN}
           , LST_ADJ_DDTM       = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
           , LST_ADJPRN_ID      = 'kicho'
       WHERE TASK_GRP_ID = #{taskGrpId}
    </update>

</mapper>
