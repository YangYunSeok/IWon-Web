<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.godisweb.mapper.meta.TermMapper">
  
  <!-- 용어 목록 조회 -->
  <select id="getTermList" parameterType="map" resultType="map">
    SELECT ROW_NUMBER() OVER (ORDER BY A.TERM_NO) AS ROW_NUM
         , A.TERM_NO
         , A.TERM_KOR_NM
         , A.TERM_ENG_NM
         , A.TERM_ENG_FULL_NM
         , A.SYS_CD
         , A.TERM_DEFIN_DSC
         , A.TERM_NOTE
         , A.TERM_APLY_RSN
         , A.DOMAIN_NO
         , (SELECT B.DOMAIN_KOR_NM FROM GPCL_META_DOMAIN B WHERE B.DOMAIN_NO = A.DOMAIN_NO) AS DOMAIN_ID
         , A.REG_ID
         , DATE_FORMAT(STR_TO_DATE(A.REG_DDTM, '%Y%m%d%H%i%s'), '%Y-%m-%d %H:%i:%s') AS REG_DDTM
         , A.LST_ADJPRN_ID
         , DATE_FORMAT(STR_TO_DATE(A.LST_ADJ_DDTM, '%Y%m%d%H%i%s'), '%Y-%m-%d %H:%i:%s') AS LST_ADJ_DDTM
      FROM GPCL_STD_TERM A
     WHERE 1=1
     <if test="TERM_KOR_NM != null and TERM_KOR_NM != ''">
       AND A.TERM_KOR_NM LIKE CONCAT('%', #{TERM_KOR_NM}, '%')
     </if>
     <if test="SYS_CD != null and SYS_CD != ''">
       AND A.SYS_CD = #{SYS_CD}
     </if>
     <if test="TERM_ENG_FULL_NM != null and TERM_ENG_FULL_NM != ''">
       AND A.TERM_ENG_FULL_NM LIKE CONCAT('%', #{TERM_ENG_FULL_NM}, '%')
     </if>
     <if test="TERM_ENG_NM != null and TERM_ENG_NM != ''">
       AND A.TERM_ENG_NM LIKE CONCAT('%', #{TERM_ENG_NM}, '%')
     </if>
     <if test="FROM_DATE != null and FROM_DATE != '' and TO_DATE != null and TO_DATE != ''">
       AND A.LST_ADJ_DDTM BETWEEN CONCAT(#{FROM_DATE}, '000000') AND CONCAT(#{TO_DATE}, '999999')
     </if>
  </select>

  <!-- 용어 상세 조회 -->
  <select id="getTermDetail" parameterType="map" resultType="map">
    SELECT A.TERM_NO
         , A.TERM_KOR_NM
         , A.TERM_ENG_NM
         , A.TERM_ENG_FULL_NM
         , A.SYS_CD
         , A.TERM_DEFIN_DSC
         , A.TERM_NOTE
         , A.TERM_APLY_RSN
         , A.DOMAIN_NO
         , A.REG_ID
         , DATE_FORMAT(STR_TO_DATE(A.REG_DDTM, '%Y%m%d%H%i%s'), '%Y-%m-%d %H:%i:%s') AS REG_DDTM
         , A.LST_ADJPRN_ID
         , DATE_FORMAT(STR_TO_DATE(A.LST_ADJ_DDTM, '%Y%m%d%H%i%s'), '%Y-%m-%d %H:%i:%s') AS LST_ADJ_DDTM
      FROM GPCL_STD_TERM A
     WHERE A.TERM_NO = #{TERM_NO}
  </select>

  <!-- 용어를 구성하는 단어 목록 조회 -->
  <select id="getTermWordList" parameterType="map" resultType="map">
    SELECT B.WORD_NO
         , B.WORD_KOR_NM
         , B.WORD_ENG_NM
         , B.WORD_SEC_CD
         , (SELECT CD_VAL_NM FROM GPCL_CM_CD_VAL WHERE GRP_CD_ID = 'WORD_SEC_CD' AND CD_VAL = B.WORD_SEC_CD) AS WORD_SEC_CD_NM
         , B.WORD_TP_CD
         , B.WORD_DTL_TP_CD
      FROM GPCL_TERM_WORD_MAPP A
      JOIN GPCL_STD_WORD B
        ON A.WORD_NO = B.WORD_NO
     WHERE A.TERM_NO = #{TERM_NO}
     ORDER BY A.SORT_ORD
  </select>

  <!-- 용어-단어 매핑 등록 -->
  <insert id="insertTermWordMapping" parameterType="map">
    INSERT INTO GPCL_TERM_WORD_MAPP (
        MAPP_NO
      , TERM_NO
      , WORD_NO
      , SORT_ORD
      , REG_ID
      , REG_DDTM
      , LST_ADJPRN_ID
      , LST_ADJ_DDTM
    ) VALUES (
        (SELECT IFNULL(MAX(MAPP_NO), 0) + 1 FROM GPCL_TERM_WORD_MAPP A)
      , #{TERM_NO}
      , #{WORD_NO}
      , #{SORT_ORD}
      , 'SYSTEM'
      , DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
      , 'SYSTEM'
      , DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
    )
  </insert>

  <!-- 용어-단어 매핑 삭제 -->
  <delete id="deleteTermWordMapping" parameterType="map">
    DELETE FROM GPCL_TERM_WORD_MAPP
     WHERE TERM_NO = #{TERM_NO}
  </delete>

  <!-- 용어영문명 중복검사 -->
  <select id="checkTermEngNmDuplicate" parameterType="map" resultType="int">
    SELECT COUNT(*)
      FROM GPCL_STD_TERM
     WHERE TRIM(UPPER(TERM_ENG_NM)) = TRIM(UPPER(#{TERM_ENG_NM}))
  </select>

  <!-- 용어 신규 등록 -->
  <insert id="insertTerm" parameterType="map" useGeneratedKeys="true" keyProperty="TERM_NO">
    INSERT INTO GPCL_STD_TERM (
        TERM_NO
      , TERM_KOR_NM
      , TERM_ENG_NM
      , TERM_ENG_FULL_NM
      , SYS_CD
      , TERM_DEFIN_DSC
      , TERM_NOTE
      , TERM_APLY_RSN
      , DOMAIN_NO
      , REG_ID
      , REG_DDTM
      , LST_ADJPRN_ID
      , LST_ADJ_DDTM
    ) VALUES (
        #{TERM_NO}
      , #{TERM_KOR_NM}
      , #{TERM_ENG_NM}
      , #{TERM_ENG_FULL_NM}
      , #{SYS_CD}
      , #{TERM_DEFIN_DSC}
      , #{TERM_NOTE}
      , #{TERM_APLY_RSN}
      , #{DOMAIN_NO}
      , 'SYSTEM'
      , DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
      , 'SYSTEM'
      , DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
    )
  </insert>

  <!-- 용어 수정 -->
  <update id="updateTerm" parameterType="map">
    UPDATE GPCL_STD_TERM
       SET TERM_KOR_NM = #{TERM_KOR_NM}
         , TERM_ENG_NM = #{TERM_ENG_NM}
         , TERM_ENG_FULL_NM = #{TERM_ENG_FULL_NM}
         , SYS_CD = #{SYS_CD}
         , TERM_DEFIN_DSC = #{TERM_DEFIN_DSC}
         , TERM_NOTE = #{TERM_NOTE}
         , TERM_APLY_RSN = #{TERM_APLY_RSN}
         , DOMAIN_NO = #{DOMAIN_NO}
         , LST_ADJPRN_ID = 'SYSTEM'
         , LST_ADJ_DDTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
     WHERE TERM_NO = #{TERM_NO}
  </update>

  <!-- 용어 삭제 -->
  <delete id="deleteTerm" parameterType="map">
    DELETE FROM GPCL_STD_TERM
     WHERE TERM_NO = #{TERM_NO}
  </delete>
  
  <!-- 모든 단어 조회 -->
  <select id="getAllWords" resultType="map">
    SELECT WORD_NO
         , WORD_KOR_NM
         , WORD_ENG_NM
         , WORD_ENG_FULL_NM
         , WORD_SEC_CD
         , (SELECT CD_VAL_NM FROM GPCL_CM_CD_VAL WHERE GRP_CD_ID = 'WORD_SEC_CD' AND CD_VAL = WORD_SEC_CD) AS WORD_SEC_CD_NM
         , WORD_TP_CD
         , WORD_DTL_TP_CD
      FROM GPCL_STD_WORD
     ORDER BY LENGTH(WORD_KOR_NM) DESC, WORD_NO
  </select>

  <!-- 동음이의어 목록 조회 -->
  <select id="getHomonymWords" parameterType="map" resultType="map">
    SELECT WORD_NO
         , WORD_KOR_NM
         , WORD_ENG_NM
         , WORD_ENG_FULL_NM
         , WORD_SEC_CD
         , WORD_TP_CD
         , WORD_DTL_TP_CD
         , (SELECT CD_VAL_NM FROM GPCL_CM_CD_VAL WHERE GRP_CD_ID = 'WORD_SEC_CD' AND CD_VAL = WORD_SEC_CD) AS WORD_SEC_CD_NM
         , '등록완료' AS WORK_STATUS_NM
      FROM GPCL_STD_WORD
     WHERE WORD_KOR_NM = #{WORD_KOR_NM}
     ORDER BY WORD_NO
  </select>
  
  <!-- 도메인 목록 조회 -->
  <select id="getDomainList" parameterType="map" resultType="map">
    SELECT DOMAIN_NO
         , DOMAIN_KOR_NM
         , DATA_TYPE_CD
         , (SELECT CD_VAL_NM FROM GPCL_CM_CD_VAL WHERE GRP_CD_ID = 'DATA_TYPE_CD' AND CD_VAL = DATA_TYPE_CD) AS DATA_TYPE_CD_NM
         , DATA_LEN
         , DATA_SCALE
      FROM GPCL_META_DOMAIN
     WHERE 1=1
       AND WORD_TP_CD     = #{WORD_TP_CD}
       AND WORD_DTL_TP_CD = #{WORD_DTL_TP_CD}
     ORDER BY DOMAIN_NO
  </select>

  <!-- 도메인 상세 조회 -->
  <select id="getDomainDetail" parameterType="map" resultType="map">
    SELECT DOMAIN_NO
         , DOMAIN_KOR_NM
         , DATA_TYPE_CD
         , DATA_LEN
         , DATA_SCALE
      FROM GPCL_META_DOMAIN
     WHERE DOMAIN_NO = #{DOMAIN_NO}
  </select>
  
  <!-- 용어영문명 중복검사-->
  <select id="checkTermEngNmDuplicateExceptSelf" parameterType="map" resultType="int">
    SELECT COUNT(*)
      FROM GPCL_STD_TERM
     WHERE TRIM(UPPER(TERM_ENG_NM)) = TRIM(UPPER(#{TERM_ENG_NM}))
       AND TERM_NO != #{TERM_NO}
  </select>
  
  <!-- 단어 번호로 단어 조회 -->
  <select id="getWordByNo" parameterType="map" resultType="map">
    SELECT WORD_NO
         , WORD_KOR_NM
         , WORD_ENG_NM
         , WORD_SEC_CD
         , WORD_TP_CD
         , WORD_DTL_TP_CD
      FROM GPCL_STD_WORD
     WHERE WORD_NO = #{WORD_NO}
  </select>
  
  <!-- 마지막 용어NO 조회 -->
  <select id="getLastTermNo" resultType="int">
    SELECT IFNULL(MAX(TERM_NO), 0) + 1
      FROM GPCL_STD_TERM
  </select>
  
  <!-- 단어 영문명으로 단어 조회 -->
  <select id="getWordByEngNm" parameterType="map" resultType="map">
    SELECT WORD_NO
         , WORD_KOR_NM
         , WORD_ENG_NM
         , WORD_SEC_CD
         , (SELECT CD_VAL_NM FROM GPCL_CM_CD_VAL WHERE GRP_CD_ID = 'WORD_SEC_CD' AND CD_VAL = WORD_SEC_CD) AS WORD_SEC_CD_NM
         , WORD_TP_CD
         , WORD_DTL_TP_CD
      FROM GPCL_STD_WORD
     WHERE WORD_ENG_NM = #{WORD_ENG_NM}
       <if test="WORD_SEC_CD != null and WORD_SEC_CD != ''">
         AND WORD_SEC_CD = #{WORD_SEC_CD}
       </if>
     LIMIT 1
  </select>
  
</mapper>