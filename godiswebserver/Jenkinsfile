pipeline {
    agent any

    environment {
        APP_NAME = "GodisWebServer"
        DEPLOY_DIR = "/opt/app"
        DEPLOY_JAR = "${DEPLOY_DIR}/${APP_NAME}.jar"
        SERVICE_NAME = "godisServer"
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Gitea ë ˆí¬ì—ì„œ ìµœì‹  ì½”ë“œ ì²´í¬ì•„ì›ƒ"
                deleteDir()
                checkout scm

                script {
                    env.GIT_COMMIT_MESSAGE = sh(
                        script: "git log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()
                }
            }
        }

        stage('Build JAR') {
            steps {
                echo "Spring Boot JAR ë¹Œë“œ"
                sh "sed -i 's/\\r\$//' gradlew"
                sh "chmod +x gradlew"
                sh "./gradlew clean build -x test"
            }
        }

        stage('Find JAR') {
            steps {
                script {
                    env.JAR_SOURCE = sh (
                        script: "ls build/libs/*.jar | grep -v plain | head -n  1",
                        returnStdout: true
                        ).trim()

                        echo "ë¹Œë“œëœ JAR: ${env.JAR_SOURCE}"
                }
            }
        }

        stage('Deploy') {
            steps {
                echo "JAR íŒŒì¼ ë°°í¬"

                sh """
                    sudo rm -f ${DEPLOY_JAR} || true
                    sudo cp ${env.JAR_SOURCE} ${DEPLOY_JAR}
                """
            }
        }

        stage('Restart Service') {
            steps {
                echo "Systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘"

                sh """
                    sudo systemctl daemon-reload
                    sudo systemctl restart ${SERVICE_NAME}
                """
            }
        }

        stage('Health Check') {
            steps {
                echo "ğŸ©º ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"

                sh """
                    if sudo systemctl is-active ${SERVICE_NAME} >/dev/null 2>&1; then
                        echo "${SERVICE_NAME} ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘"
                    else
                        echo "${SERVICE_NAME} ì‹¤í–‰ ì‹¤íŒ¨"
                        sudo systemctl status ${SERVICE_NAME} -l
                        exit 1
                    fi
                """
            }
        }
    }

    post {
        success {
            slackSend (
                message: """
*ì„œë²„ ë¹Œë“œ ì„±ê³µ ğŸ‰*
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]
URL: ${env.BUILD_URL}
ì»¤ë°‹ ë©”ì‹œì§€: ${env.GIT_COMMIT_MESSAGE}
"""
            )
        }
        failure {
            slackSend (
                message: """
*ì„œë²„ ë¹Œë“œ ì‹¤íŒ¨ âŒ*
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]
URL: ${env.BUILD_URL}
ì»¤ë°‹ ë©”ì‹œì§€: ${env.GIT_COMMIT_MESSAGE}
"""
            )
        }
    }
}
